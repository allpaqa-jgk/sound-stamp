# 02. A/B ウォーターマーク仕様 (Phase A/B)

## 1. 概要

A/B ウォーターマークは、すべて **フロントエンド側で完結** する。

- A: 振幅を画像パターンに応じて変調し、スペクトログラム上にロゴ・文字として現れる。
- B: 位相を画像パターンに応じて 0 方向へ偏らせ、位相解析したときにロゴが現れる。

将来的に C を追加しても、A/B の処理フローは変えず、**「A → B → C」順に複素スペクトルを変調するパイプライン**とする。

## 2. STFT / IFFT パラメータ

- サンプリングレート: **48,000 Hz**
- FFT サイズ: **512**
- ホップサイズ: **256**（50% オーバーラップ）
- 窓関数: **Hann 窓**
- 使用周波数ビン: k = 1..256（0=DC, 256=Nyquist は実数）

1 フレーム = 512 サンプル  
64 フレーム ≒ 64 × 256 / 48,000 ≒ 0.341 秒  
256 フレーム ≒ 約 1.37 秒

## 3. 画像パラメータ

- 入力画像 A, B はそれぞれ **64×64 のグレースケール画像**。
- 周波数軸（256 ビン）は 4 バンドに等分割（各 64 ビン）。
- 各バンドに対して画像の縦 64 ピクセルをマッピングする。

時間方向は、64 フレームごとに同じ 64×64 パターンがタイル状に敷き詰められる設計とし、  
ブロック平均による S/N 向上を解析時に活用できるようにする。

## 4. ベースノイズスペクトル生成

各フレーム、各周波数ビンについて：

1. ベースの振幅 `mag[k]` を 0.8 程度に設定（後に A/B で変調）。  
2. 位相 `phase[k]` を [0, 2π) の一様乱数で生成。  
3. 複素スペクトル `X[k] = mag[k] * exp(i * phase[k])` を得る。  
4. k=0 は 0、k=256 は実数小値とする。  
5. 負の周波数側は Hermitian 対称 `X[512-k] = conjugate(X[k])` とする。

## 5. A マーク（振幅変調）

画像 A(x, y)（0〜1 の輝度とする）に従い、各フレームの振幅を変調する。

- y: 0..63 → 周波数ビン k = bandOffset + (y + 1)
- x: 0..63 → 時間フレーム index に対応（タイルの位置による）

例: 黒いほど振幅を上げる（ロゴが明るく見える）場合：

```ts
// a: 画像輝度 (0=黒, 1=白)
const minAmp = 0.4;
const maxAmp = 0.8;
mag[k] = minAmp + (1 - a) * (maxAmp - minAmp);
```

この処理のみで A ウォーターマークが成立する。  
B/C を無効にしても問題なく音声が生成できるようにする。

## 6. B マーク（位相変調）

画像 B(x, y)（0〜1）の値を用いて、ランダム位相 `phase0[k]` を「0 方向へ寄せる」。

- b=0 → 元のランダム位相を維持  
- b=1 → 位相を 0 に近づける

例：

```ts
// 0..1
const b = brightnessB;
const phase = phase0 * (1 - b); // 1 に近いほど 0 に寄る
X[k] = mag[k] * Math.exp(1j * phase);
```

完全に 0 に固定せず、「元のランダム」と「0」の間を補間することで、  
聴感的な不自然さを抑えつつ、位相ロゴ検出が可能な程度の偏りを持たせる。

## 7. IFFT とオーバーラップ加算

各フレームごとに複素スペクトル X を IFFT し、Hann 窓をかけてホップサイズ 256 で OLA（Overlap-Add）する。

- 窓: Hann
- hop: 256
- COLA 条件を満たすために窓はそのまま掛けて足し合わせる（最大値で正規化しない）。

最終的に得られる波形は約 1.37 秒（256 フレーム）となる。  
これをそのまま 2 秒や 4 秒のループ音源として扱ってよい。

## 8. 解析（A/B 用）

### 8.1 STFT 再計算

解析時も同じパラメータで STFT を行う：

- FFT=512, hop=256, Hann 窓

### 8.2 ブロック平均

64 フレームを 1 ブロックとみなし、同じパターンが繰り返されている前提で、  
各ブロックを次のように処理する：

- A 用: 振幅（またはパワー）を線形スケールで足し合わせ → 後で log 表示。  
- B 用: 複素正規化 `X/|X|` を行い、複素ベクトルとして平均 → ベクトル長・方向から位相偏りを評価。

複数ブロックをさらに平均することで、演奏音・BGM 由来のランダム成分を弱め、  
ウォーターマーク由来のパターンを強調する。

## 9. C 追加を見据えた拡張ポイント

A/B 実装時点で、スペクトル変調のフローを必ず関数化しておく：

```ts
applyAmplitudeMark(X, AImage, params);    // A
applyPhaseMark(X, BImage, params);        // B
// ここに将来 C を差し込む
// applyCTokenMark(X, token128, patternId, params);
```

C 導入時はこのフックに対して微小な位相／振幅の追加変調を行うのみで済むようにする。
