# 03. C ウォーターマーク仕様 (Crypto / Token Mark)

## 1. 目的

C ウォーターマークは、**128bit トークン** を音声信号に不可視で埋め込み、  
盗用時に強い証拠として利用できることを目的とする。

- A/B: スペクトログラム上で視覚的に確認できる証拠  
- C: 公開鍵暗号またはトークン照合により、「誰・いつ」の音声かを特定する暗号的証拠

## 2. 要件

- 埋め込まれた 128bit は、攻撃者が意図せずに除去しづらいこと  
- 攻撃者が別の C を再埋め込みしても、元の C と区別できること  
- 再生・配信・エンコード（Opus/AAC）を経ても、十分な確率で復号可能なこと  
- 署名方式を採用する場合、公開鍵のみで検証可能であること（秘密鍵はサーバ管理）

## 3. トークン設計

### 3.1 トークン構造

128bit の内部構造は実装時に詳細設計するが、概念的には：

- 一部: ユーザー UID 由来（ハッシュ or プレフィクス）
- 一部: 日付・時間（dayIndex + 秒単位などを圧縮）
- 一部: ランダム or 署名のハッシュ

これ自体をそのまま公開しても良いし、  
署名スキームを採用する場合は「署名値そのもの」を 128bit に圧縮する案もありうる。

### 3.2 Firestore との紐づけ

コレクション `tokens/{tokenId}` のイメージ：

```jsonc
{
  "uid": "FirebaseAuth UID",
  "createdAt": "... Firestore timestamp ...",
  "streamDate": "YYYY-MM-DD",
  "metadata": {
    "appVersion": "v1",
    "aHash": "hash-of-A-image",
    "bHash": "hash-of-B-image"
  }
}
```

tokenId は、128bit を base64url / hex 等で表現したものでも良い。

## 4. 埋め込み方式（概要）

### 4.1 Spread Spectrum 的な振幅／位相変調

- 各ビットを、複数の周波数ビン・時間ブロックにまたがって埋め込む（冗長化）。  
- 振幅：±数％の微小変化  
- 位相：±Δφ の微小偏移  

いずれも A/B よりも強度を低くし、聴感への影響を最小限にする。

### 4.2 パターンIDによるレイアウト多様化

トークンごとに、埋め込む位置・周波数帯・ブロックを変えるため、

- `patternId = HMAC(secret, token128)` の下位 10 ビットなどを用い、  
- 0〜1023 のパターンから 1 つを選択。  
- 各 patternId ごとに、「どのビン／どのフレーム」に埋めるかのレイアウトを定義。

これにより、

- 攻撃者が埋め込み位置を一意に特定しづらくなる  
- 盗用者が sound-stamp を通して再埋め込みしても、元の C と後からの C を区別できる

## 5. 復号・検証

### 5.1 冗長化と多数決

- 各トークンは複数チャネル（周波数帯・時間ブロック・方式）に重複して埋め込まれる。  
- デコード時は、各チャネルからビット推定を行い、  
  - 多数決  
  - または簡易誤り訂正（例: BCH, Reed-Solomon）  
  により 128bit を再構成する。

### 5.2 署名検証またはトークン照合

- 署名方式の場合：  
  - 公開鍵で 128bit 署名の検証を行う  
  - 検証が通れば「sound-stamp が発行した正当なトークンである」と言える

- トークン照合方式の場合：  
  - `tokens` コレクションで tokenId を検索  
  - 一致すれば、その uid / 日付 / メタデータが取得可能

## 6. A/B 実装との関係

- C は A/B の後に適用される追加の変調として設計する。  
- A/B の処理が完成している状態に対して、`applyCTokenMark` を呼び出すだけで済むようにする。  
- C 無効時は `applyCTokenMark` をスキップするだけで良い。A/B のコード変更は不要とする。

## 7. 実装フェーズ

Phase C に入るまでの間は：

- `@soundstamp/core` に `applyCTokenMark` の空実装（no-op）を用意しておく。  
- Firestore / Functions のスキーマ・API 設計のみ先に固めておき、  
  実装は A/B の安定後に行う。
